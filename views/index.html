<!DOCTYPE html>
<html>
<head>
    <title>House of Venus | City as a Service | viewXR</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <link rel="stylesheet" href="./css/viewXR.css" type="text/css" />
    <script>
        document.addEventListener("DOMContentLoaded", function(){
          // Put variables in global scope to make them available to the browser console.
              var video = document.querySelector('video');
              var constraints = window.constraints = {
                  audio: false,
                  video: true
              };
              var errorElement = document.querySelector('#errorMsg');

              navigator.mediaDevices.getUserMedia(constraints).then(function(stream) {
                  var videoTracks = stream.getVideoTracks();
                  console.log('Got stream with constraints:', constraints);
                  console.log('Using video device: ' + videoTracks[0].label);
                  stream.onremovetrack = function() {
                      console.log('Stream ended');
                  };

                  window.stream = stream; // make variable available to browser console
                  video.srcObject = stream;
              })
              .catch(function(error) {
                  if (error.name === 'ConstraintNotSatisfiedError') {
                      errorMsg('The resolution ' + constraints.video.width.exact + 'x' + constraints.video.width.exact + ' px is not supported by your device.');
                  } else if (error.name === 'PermissionDeniedError') {
                      errorMsg('Permissions have not been granted to use your camera and ' +
                    'microphone, you need to allow the page access to your devices in ' +
                    'order for the demo to work.');
                  }
                  errorMsg('getUserMedia error: ' + error.name, error);
              });

              function errorMsg(msg, error) {
                  errorElement.innerHTML += '<p>' + msg + '</p>'+'<p>' + error + '</p>';

                  if (typeof error !== 'undefined') {
                      console.error(error);
                  }
              }

              var  viewerContainerSeries = [
                  {
                      top: 0,
                      marginTop: 0,
                      marginLeft: "-320",
                      width: 640,
                      height: 480,
                  },
                  {
                      top: 0,
                      marginTop: 0,
                      marginLeft: "-240",
                      width: 480,
                      height: 360,
                  },
                  {
                      top: 0,
                      marginTop: 0,
                      marginLeft: "-180",
                      width: 360,
                      height: 270,
                      left: 0
                  },
                  {
                      top: 0,
                      marginTop: 0,
                      marginLeft: "-120",
                      width: 240,
                      height: 180,
                      left: 0
                  }
              ];

              var viewerTracker = [
                  document.getElementById("webcam-0-container"),
              ];

              var sessionManager = {
                  statusShown: false,
                  screenCount: 1,
              };

              function splitScreen(){ /*
                                      *   splits the screen to allow for multiple "desktops",
                                      *   i.e. connect to various cARds locally by tapping or
                                      *   remotely via pARk broadcast
                                      */

                  let nextView = document.createElement("video");
                  nextView.setAttribute("id", `webcam-${viewerTracker.length}-container`);
                  nextView.classList.add(`viewer-container`);

                  viewerTracker.push(nextView);
                  console.log(viewerTracker);
                  console.log("-------------------------------------------------");
                  let topMult = 0;
                  for(var i=0; i<viewerTracker.length; i++){
                      (function(){
                          let videoContainer = viewerTracker[i];
                          console.log(viewerTracker[i]);
                          if(viewerTracker.length>3){

                              if(i>0){
                                  let mult = i % 3;
                                  videoContainer.style.left = (mult*viewerContainerSeries[2].width)+"px";
                                  if(mult==0){
                                      topMult++;
                                  }
                              }
                              else{
                                  viewerContainerSeries[2].marginLeft = 0;
                                  videoContainer.style.left = viewerContainerSeries[2].left;
                              }
                              console.log(topMult);
                              videoContainer.style.top = (topMult*viewerContainerSeries[2].height)+"px";
                              //videoContainer.style.top = viewerContainerSeries[2].top;
                              videoContainer.style.marginTop = viewerContainerSeries[2].marginTop;
                              videoContainer.style.marginLeft = viewerContainerSeries[2].marginLeft+"px";

                              videoContainer.setAttribute("width", viewerContainerSeries[2].width);
                              videoContainer.style.width = viewerContainerSeries[2].width+"px";
                              videoContainer.setAttribute("height",viewerContainerSeries[2].height);
                              videoContainer.style.height = viewerContainerSeries[2].height+"px";
                          }
                          else{
                              let count = viewerTracker.length-1;
                              if(i>0){
                                  videoContainer.style.top = (i*viewerContainerSeries[count].height)+"px";
                              }
                              else{
                                  videoContainer.style.top = viewerContainerSeries[count].top;
                              }
                              videoContainer.style.marginTop = viewerContainerSeries[count].marginTop;
                              videoContainer.style.marginLeft = viewerContainerSeries[count].marginLeft+"px";
                              videoContainer.setAttribute("width", viewerContainerSeries[count].width);
                              videoContainer.style.width = viewerContainerSeries[count].width+"px";
                              videoContainer.setAttribute("height", viewerContainerSeries[count].height);
                              videoContainer.style.height = viewerContainerSeries[count].height+"px";
                          }

                          document.getElementById("main-app-container").appendChild(videoContainer);
                      })();
                  }

              }

              function showLinkStatusDisplay(code){
                  let type = code;
                  let linkStatusDisplay, linkStatusDisplayBar, linkStatusDisplayBarContainer, linkStatusDisplayTitle, linkStatusDisplayContent;
                  if(sessionManager.statusShown){
                      console.log("dom elements for link status display already created");
                      linkStatusDisplay = document.getElementById("link-status-display-container");
                      linkStatusDisplayTitle = document.getElementById("link-status-display-title-container");
                      linkStatusDisplayBar = document.getElementById("link-status-display-bar");
                      linkStatusDisplayBarContainer = document.getElementById("link-status-display-bar-container");
                      linkStatusDisplayContent = document.getElementById("link-status-display-content-container");
                  }
                  else{
                      linkStatusDisplay = document.createElement("div");
                      linkStatusDisplayTitle = document.createElement("div");
                      linkStatusDisplayBar = document.createElement("div");
                      linkStatusDisplayBarContainer = document.createElement("div");
                      linkStatusDisplayContent = document.createElement("div");
                      linkStatusDisplay.setAttribute("id","link-status-display-container");
                      linkStatusDisplayTitle.setAttribute("id","link-status-display-title-container");
                      linkStatusDisplayBarContainer.setAttribute("id","link-status-display-bar-container");
                      linkStatusDisplayContent.setAttribute("id","link-status-display-content-container");
                      linkStatusDisplayBar.setAttribute("id","link-status-display-bar");
                  }
                  linkStatusDisplayBar.style.width = 0;
                  /*    while (myNode.firstChild) {
                      myNode.removeChild(myNode.firstChild);
                  }
                  */
                  if(type==0){
                          console.log("hahaha");
                          linkStatusDisplayTitle.innerHTML = "Connect"
                          linkStatusDisplayContent.innerHTML = "<p style='width: 80%; margin: 0 auto; display: block; padding-top: 5%; text-align: center;'> Opening this <span style='font-weight:900;'>cARd</span> and loading its Lyoko Ledgerspace Token...</p>";
                  }
                  else if(type==1){
                        console.log("oooooo");
                        linkStatusDisplayTitle.innerHTML= "Link"
                        linkStatusDisplayContent.innerHTML = "<p style='width: 70%; margin: 0 auto; text-align: center; padding-top: 5%;'> Linking this session to another <span style='font-weight:900;'>cARd</span>...</p>";
                  }
                  else{
                      linkStatusDisplayTitle.textContent = "Link Status Display"
                      linkStatusDisplayContent.innerHTML = "<p> text will go here </p>";
                      console.log("no code provided");
                  }

                  if(sessionManager.statusShown){
                      linkStatusDisplay.style.display = "block"
                  }
                  else{
                      linkStatusDisplayBarContainer.appendChild(linkStatusDisplayBar);
                      linkStatusDisplay.appendChild(linkStatusDisplayTitle);
                      linkStatusDisplay.appendChild(linkStatusDisplayBarContainer);
                      linkStatusDisplay.appendChild(linkStatusDisplayContent);

                      document.getElementById("main-app-container").appendChild(linkStatusDisplay);
                  }
                  setTimeout(function(){
                      linkStatusDisplayBar.style.width = "100%";
                  }, 50);

                  setTimeout(function(){
                      linkStatusDisplay.style.display = "none";
                      sessionManager.statusShown = true;
                  }, 3100);
                  //}

              }

              function activateDeviceNFCReader(){
                  console.log("TODO: checking if device nfc reader is already active...");
                  console.log("TODO: activating device nfc reader...");
              }

              function connectToRFID(){
                  activateDeviceNFCReader();
                  opencARd(0);
              }

              function opencARd(code){
                  showLinkStatusDisplay(code);
              }

              document.getElementById("connect-to-rfid-menu-button").addEventListener("click", function(){
                  connectToRFID();
              });

              document.getElementById("link-to-new-rfid-menu-button").addEventListener("click", function(){
                  activateDeviceNFCReader();
                  splitScreen();
                  opencARd(1);
              });

              document.getElementById("split-screen-menu-button").addEventListener("click", function(){ //
                  splitScreen();
              });
        });
    </script>
</head>
<body>
    <!-- Stream video via webcam -->
    <div id="main-app-container">
        <video id="webcam-0-container" class="viewer-container" autoplay width="640" height="480" style="border: black 2px solid;"></video>
        <div id="errorMsg"></div>
        <div class="menu-container">
            <div id="connect-to-rfid-menu-button" class="menu-button">conn</div>
            <div id="link-to-new-rfid-menu-button" class="menu-button">link</div>
            <div id="split-screen-menu-button" class="menu-button">splt</div>
        </div>
    </div>
</body>
</html>
<!-- In the pARk, there is a store called "Snack Shack".
In this store, you can stream whatever content you like
and watch it with friends. You can also order snacks delivered
 straight to your Cloud.-->


 <!-- In the pARk, there is a store called "House of Venus".
 This store is owned and operated by me, Patrice-Morgan Ongoly, along with
 Louis Banzani, Cameron Reed, Noah Dagne, and Guedalia Dina-Lenda. In our store,
 visitors can preview our two currently listed products: the "creative Augmented
 Reality desktop" ("cARd") and the "Augmented Reality internet assistant" ("ARia").
 The "cARd" is available for purchase at
 In this store, visiors can preview or buy two currently listed products:
 the House of Venus creative Augmented Reality desktop ("cARd") and the House of Venus Augmented Reality intelligent assistant ("ARia").
  can stream whatever content you like
 and watch it with friends. You can also order snacks delivered
  straight to your Cloud.-->
